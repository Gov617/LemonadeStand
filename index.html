<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lemonade Class ‚Äî Classroom MVP</title>
  <meta name="description" content="Lemonade Class: a classroom-ready micro-business simulation that teaches revenue, profit, margin, and decision-making." />

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(0,0,0,.14);
      --line: rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted:#a9b7e6;
      --good:#26d07c;
      --bad:#ff4d4d;
      --warn:#ffd166;
      --btn:#2b5cff;
      --shadow: 0 16px 46px rgba(0,0,0,.38);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, #1b2d65 0%, var(--bg) 60%),
        radial-gradient(900px 600px at 90% 10%, #162552 0%, transparent 50%);
    }

    /* Teacher mode = visibly different feel */
    body[data-role="teacher"]{
      background:
        radial-gradient(1100px 700px at 15% 0%, #2a1b65 0%, #0b1220 60%),
        radial-gradient(900px 600px at 90% 10%, #1b3b6a 0%, transparent 50%);
    }
    body[data-role="teacher"] .nav{
      border-color: rgba(255,255,255,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px}

    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      backdrop-filter: blur(8px);
      z-index: 5;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brandMark{
      width:52px; height:52px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .brandMark img{ width:100%; height:100%; object-fit:contain; display:block; transform: scale(1.03); }
    .title{display:flex; flex-direction:column; line-height:1.1;}
    .title b{font-size:16px; letter-spacing:-.01em}
    .title span{font-size:12px; color:rgba(233,238,252,.70)}

    .navRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{
      display:flex; gap:8px; align-items:center; white-space:nowrap;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-size:13px;
    }
    .chip b{color:var(--text); font-weight:950}
    .roleBadge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(233,238,252,.85);
      font-weight:950;
      letter-spacing: .08em;
    }
    .navBtns{display:flex; gap:10px; flex-wrap:wrap}

    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      transition: transform .05s ease;
    }
    button:active{transform: scale(.98)}
    button.primary{background: var(--btn); border-color: rgba(43,92,255,.65)}
    button.ghost{background: rgba(0,0,0,.14)}
    button.danger{background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.45)}
    button.ok{background: rgba(38,208,124,.12); border-color: rgba(38,208,124,.45)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .grid{display:grid; grid-template-columns: 1.55fr .85fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .muted{color:var(--muted); font-size:13px; line-height:1.4}
    .mini{color:rgba(233,238,252,.72); font-size:12px}
    .sep{height:1px;background: rgba(255,255,255,.10); margin:14px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{display:block; font-size:13px; color:var(--muted); margin:12px 0 6px}

    input[type="text"], input[type="password"], select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color:var(--text);
      outline:none;
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 700px){ .two{grid-template-columns:1fr} }

    input[type="range"]{width:100%}
    .rangeRow{display:flex; gap:10px; align-items:center}
    .rangeVal{min-width:120px;text-align:right;color:var(--text);font-weight:950;}

    .pillRow{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding:9px 11px;
      border-radius:999px;
      font-size:13px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color: var(--text); font-weight:950}

    .callout{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(43,92,255,.35);
      background: rgba(43,92,255,.10);
      color: rgba(233,238,252,.95);
      font-size:13px;
      line-height:1.35;
    }
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,209,102,.35);
      background: rgba(255,209,102,.10);
      color: #ffe7a7;
      font-size:13px;
      line-height:1.35;
    }

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .tab{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color: rgba(233,238,252,.9);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(43,92,255,.16);
      border-color: rgba(43,92,255,.45);
    }

    .list{display:grid; gap:8px; margin-top:8px}
    .li{
      display:flex; justify-content:space-between; gap:10px;
      font-size:13px; color:var(--muted);
      padding:10px 10px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
    }
    .li b{color:var(--text)}
    .good{color:var(--good); font-weight:950}
    .bad{color:var(--bad); font-weight:950}

    .selling{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:12px;
      background: rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      margin-top:10px;
    }
    .meter{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      padding:10px 12px; border-radius:16px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.12);
      min-width:165px;
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:950;margin-top:2px}

    .hide{display:none !important}

    /* Settings Drawer */
    .drawer{
      margin-top:12px;
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
    }
    .drawerHead{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .drawerHead b{font-size:14px}
    .drawerBody{margin-top:10px}

    /* Home hero */
    .homeHero{
      display:flex;
      gap:14px;
      align-items:center;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      margin-top:12px;
    }
    .heroLogo{
      width:86px; height:86px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .heroLogo img{width:100%; height:100%; object-fit:contain; display:block; transform: scale(1.02);}

    /* Splash */
    #splash{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 20% 0%, rgba(255,209,102,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(43,92,255,.18), transparent 55%),
                  rgba(6,10,20,.92);
      display:none;
      place-items:center;
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    .splashCard{
      width:min(520px, 92vw);
      padding:22px 20px 18px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      text-align:center;
      position:relative;
    }
    #splashLogo{
      width:120px; height:120px;
      object-fit:contain;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
      padding:10px;
    }
    .splashTitle{ font-weight:1000; font-size:22px; margin-top:12px; letter-spacing:-.02em; }
    .splashSub{ color: rgba(233,238,252,.74); font-size:13px; margin-top:6px; }
    .splashBar{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      margin:16px 0 4px;
    }
    .splashFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,209,102,.95), rgba(43,92,255,.95));
      transition: width 1.6s linear;
    }

    /* Modal (Teacher PIN) */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      z-index: 10000;
      backdrop-filter: blur(6px);
    }
    .modal{
      width:min(520px, 92vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 30px 80px rgba(0,0,0,.65);
      padding:16px;
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .modalHead b{font-size:14px}
    .modalMsg{color: rgba(233,238,252,.78); font-size:13px; line-height:1.35}
    .modalErr{margin-top:10px; color: #ffb0b0; font-weight:900; font-size:13px; display:none;}
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-weight:950;
      font-size:12px;
      color: rgba(233,238,252,.92);
    }

    /* Teacher-only panel feel */
    body[data-role="teacher"] .teacherPanel{
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.10));
    }

    @media print{
      body{background:#fff; color:#000}
      .wrap{max-width:100%; padding:0}
      .nav, #historyCard, #startView, #dayView, #teacherView { display:none !important; }
      #resultView{display:block !important}
      .card{box-shadow:none; border:1px solid #ddd; background:#fff}
      .pill, .chip{background:#f3f3f3; border-color:#ddd; color:#111}
      .muted{color:#222}
      .hint{color:#111; background:#fff6d6; border-color:#e7cf7a}
      .callout{color:#111; background:#eaf0ff; border-color:#b6c6ff}
      button{display:none !important}
      textarea{border:1px solid #bbb; background:#fff; color:#000}
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash">
    <div class="splashCard">
      <img id="splashLogo" alt="Lemonade Class" />
      <div class="splashTitle">Lemonade Class</div>
      <div class="splashSub">A classroom-ready business simulation</div>
      <div class="splashBar"><div class="splashFill" id="splashFill"></div></div>
      <div class="mini">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Teacher PIN modal -->
  <div id="pinModalBack" class="modalBack">
    <div class="modal">
      <div class="modalHead">
        <b>Teacher Access</b>
        <button class="ghost" id="btnPinClose">Close</button>
      </div>
      <div class="modalMsg">
        Enter the <b>4-digit Teacher PIN</b> to open <span class="kbd">Teacher Mode</span>.
        <div class="mini" style="margin-top:6px;">Default PIN is set by the teacher (MVP ships with <b>1111</b>).</div>
      </div>

      <div class="two" style="margin-top:12px;">
        <div>
          <label>Teacher PIN</label>
          <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <div class="mini" style="margin-top:6px;">Tip: PIN is stored locally on this device.</div>
        </div>
        <div>
          <label>Remember for this tab session</label>
          <select id="pinRemember">
            <option value="yes" selected>Yes (recommended)</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="btnPinSubmit">Unlock Teacher Mode</button>
        <button class="ghost" id="btnPinCancel">Cancel</button>
      </div>

      <div id="pinErr" class="modalErr">Incorrect PIN.</div>
    </div>
  </div>

  <div class="wrap">

    <!-- NAV -->
    <div class="nav">
      <div class="brand">
        <div class="brandMark">
          <img id="navLogo" alt="Lemonade Class logo" />
        </div>
        <div class="title">
          <b>Lemonade Class</b>
          <span>Micro-business simulation ‚Ä¢ classroom-ready</span>
        </div>
      </div>

      <div class="navRight">
        <div class="chip">üíµ Cash: <b id="cashPill">$0.00</b></div>
        <div class="chip">üìÖ Day: <b id="dayPill">‚Äî</b></div>
        <div class="chip">‚≠ê Rep: <b id="repPill">‚Äî</b></div>
        <div class="chip">üß† Explain: <b id="explainPill">On</b></div>
        <div class="roleBadge" id="roleBadge">STUDENT</div>

        <div class="navBtns">
          <button class="ghost" id="btnHome" title="Go to Home">Home</button>
          <button class="ghost hide" id="btnTeacher" title="Teacher Dashboard">Teacher</button>
          <button class="ghost" id="btnToggleSettings" title="Open Settings">Settings</button>
          <button class="danger" id="btnRestart" title="Restart this run">Restart</button>
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT -->
      <div class="card">

        <!-- SETTINGS DRAWER -->
        <div id="settingsDrawer" class="drawer hide">
          <div class="drawerHead">
            <b id="settingsTitle">Settings</b>
            <button class="ghost" id="btnCloseSettings">Close</button>
          </div>
          <div class="drawerBody">

            <div class="two">
              <div>
                <label>Mode</label>
                <select id="userRole">
                  <option value="student" selected>Student Mode</option>
                  <option value="teacher">Teacher Mode (PIN)</option>
                </select>
                <div class="mini" style="margin-top:6px">Teacher Mode unlocks analytics + class controls.</div>
              </div>
              <div>
                <label>Explain Mode</label>
                <select id="explainMode">
                  <option value="on" selected>On (recommended)</option>
                  <option value="off">Off</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Student name</label>
                <input id="playerName" type="text" placeholder="e.g., Marcus" maxlength="24" />
              </div>
              <div>
                <label>Class code (optional)</label>
                <input id="classCode" type="text" placeholder="e.g., 6B-Period2" maxlength="24" />
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Teacher name (optional)</label>
                <input id="teacherName" type="text" placeholder="e.g., Ms. Rivera" maxlength="32" />
              </div>
              <div id="lockWrap">
                <label>Lock Student Settings (Teacher)</label>
                <select id="lockStudentSettings">
                  <option value="no" selected>No</option>
                  <option value="yes">Yes (hide Settings for students)</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div id="pinWrap">
                <label>Teacher PIN (4 digits)</label>
                <input id="teacherPin" type="password" inputmode="numeric" maxlength="4" placeholder="1111" />
                <div class="mini" style="margin-top:6px">Teacher-only. Students never see this field.</div>
              </div>
              <div>
                <label>Game length</label>
                <select id="gameLen">
                  <option value="5">5 days</option>
                  <option value="7" selected>7 days</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Difficulty</label>
                <select id="difficulty">
                  <option value="guided">Guided (gentle)</option>
                  <option value="standard" selected>Standard</option>
                  <option value="competitive">Competitive (hard)</option>
                </select>
              </div>
              <div>
                <label>Starting cash</label>
                <select id="startingCash">
                  <option value="50">$50 (hard)</option>
                  <option value="100" selected>$100 (normal)</option>
                  <option value="150">$150 (easier)</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Cost mode</label>
                <select id="costMode">
                  <option value="simple" selected>Simple (1 cost per cup)</option>
                  <option value="advanced">Advanced (adds ‚ÄúQuality‚Äù choice)</option>
                </select>
              </div>
              <div>
                <label>Base ingredient cost (COGS per cup)</label>
                <select id="cogsPerCup">
                  <option value="0.35">$0.35</option>
                  <option value="0.50" selected>$0.50 (default)</option>
                  <option value="0.70">$0.70</option>
                  <option value="1.00">$1.00</option>
                </select>
              </div>
            </div>

            <div class="two" style="margin-top:10px">
              <div>
                <label>Foot traffic level</label>
                <select id="scenarioTraffic">
                  <option value="low">Low foot traffic</option>
                  <option value="med" selected>Medium foot traffic</option>
                  <option value="high">High foot traffic</option>
                </select>
              </div>
              <div>
                <label>Customer mix</label>
                <select id="scenarioMix">
                  <option value="price">Price-sensitive shoppers</option>
                  <option value="balanced" selected>Balanced shoppers</option>
                  <option value="convenience">Convenience-focused shoppers</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="primary" id="btnApplySettings">Apply Settings (restart run)</button>
              <button class="ghost" id="btnSaveSettings">Save Settings (keep run)</button>
            </div>

            <div class="hint" style="margin-top:12px">
              <b>Teacher note:</b> Waste cost is shown as a teaching callout. Fixed costs + reputation make ‚Äúautopilot profit‚Äù impossible.
            </div>

          </div>
        </div>

        <!-- START VIEW -->
        <div id="startView">
          <h2>Home</h2>
          <div class="muted">
            Run a lemonade stand for <b>5 or 7 days</b>. Learn <b>revenue vs profit</b> with real tradeoffs.
          </div>

          <div class="homeHero">
            <div class="heroLogo">
              <img id="homeLogo" alt="Lemonade Class logo" />
            </div>
            <div>
              <div style="font-weight:950; font-size:14px;">Welcome to Lemonade Class</div>
              <div class="mini" style="margin-top:6px;">
                Decide ‚Üí sell ‚Üí review results ‚Üí reflect. Built for computer labs & tablets.
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="two">
            <div>
              <label>Mode</label>
              <select id="userRole2">
                <option value="student" selected>Student Mode</option>
                <option value="teacher">Teacher Mode (PIN)</option>
              </select>
            </div>
            <div>
              <label>Quick start preset</label>
              <select id="preset">
                <option value="standard" selected>Standard classroom</option>
                <option value="guided">Guided (easier)</option>
                <option value="competitive">Competitive (hard)</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Student name</label>
              <input id="playerName2" type="text" placeholder="e.g., Marcus" maxlength="24" />
            </div>
            <div>
              <label>Class code (optional)</label>
              <input id="classCode2" type="text" placeholder="e.g., 6B-Period2" maxlength="24" />
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>Teacher name (optional)</label>
              <input id="teacherName2" type="text" placeholder="e.g., Ms. Rivera" maxlength="32" />
            </div>
            <div></div>
          </div>

          <div class="tabs" style="margin-top:12px">
            <div class="tab active" data-tab="learn" id="tabLearn">Learn</div>
            <div class="tab" data-tab="play" id="tabPlay">Play</div>
            <div class="tab" data-tab="teach" id="tabTeach">Teacher</div>
          </div>

          <div id="homeLearn" style="margin-top:12px">
            <div class="callout">
              <b>Fast lesson:</b> Revenue is money you collect. Profit is what‚Äôs left after costs.
              You‚Äôll face <b>fixed costs</b> and <b>reputation</b> (trust) that affect future demand.
            </div>
            <div class="hint">
              Win by matching <b>price</b> + <b>inventory</b> to <b>demand</b>‚Äîwhile protecting reputation.
            </div>
          </div>

          <div id="homePlay" class="hide" style="margin-top:12px">
            <div class="muted">Start the run. You‚Äôll get a print-ready reflection sheet at the end.</div>
          </div>

          <div id="homeTeach" class="hide" style="margin-top:12px">
            <div class="muted">
              Teacher Mode adds a dashboard + class controls. Students keep a clean game experience.
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button class="primary" id="btnStart">Start Game</button>
            <button class="ghost hide" id="btnResume">Resume Saved Run</button>
            <button class="danger hide" id="btnClear">Clear Save</button>
          </div>
        </div>

        <!-- DAY VIEW -->
        <div id="dayView" class="hide">
          <h2 id="dayTitle">Day</h2>

          <div class="pillRow">
            <div class="pill">üå¶Ô∏è Weather: <b id="wxPill">‚Äî</b></div>
            <div class="pill">üé™ Event: <b id="eventPill">‚Äî</b></div>
            <div class="pill">ü•§ Rival: <b id="rivalPill">‚Äî</b></div>
            <div class="pill">üëü Traffic: <b id="trafficPill">‚Äî</b></div>
            <div class="pill">üß† Mix: <b id="mixPill">‚Äî</b></div>
          </div>

          <div class="sep"></div>

          <label>Cups to make</label>
          <div class="rangeRow">
            <input id="cups" type="range" min="0" max="200" value="80" />
            <div class="rangeVal" id="cupsVal">80</div>
          </div>

          <label>Price per cup</label>
          <div class="rangeRow">
            <input id="price" type="range" min="0.5" max="5" value="2.00" step="0.05" />
            <div class="rangeVal" id="priceVal">$2.00</div>
          </div>

          <div id="qualityWrap" class="hide">
            <label>Quality (Advanced costs)</label>
            <select id="quality">
              <option value="cheap">Cheap (lower cost, hurts reputation)</option>
              <option value="standard" selected>Standard (balanced)</option>
              <option value="premium">Premium (higher cost, boosts reputation)</option>
            </select>
            <div class="mini" style="margin-top:6px;">Students choose quality only in Advanced mode.</div>
          </div>

          <label>Marketing spend</label>
          <div class="rangeRow">
            <input id="mkt" type="range" min="0" max="20" value="0" step="1" />
            <div class="rangeVal" id="mktVal">$0</div>
          </div>

          <div class="callout">
            Up-front spend today: <b id="upfrontSpendVal">$0.00</b>
            <span class="mini">
              (COGS <span id="cogsTag">$0.50</span> √ó cups + marketing + fixed cost <span id="fixedTag">$0.00</span>)
            </span>
          </div>

          <div id="explainTips" class="hint hide"></div>

          <div class="row" style="margin-top:14px">
            <button class="primary" id="btnSell">Start Selling</button>
            <button class="ghost" id="btnResetDay">Reset</button>
          </div>

          <div id="sellingBox" class="selling hide">
            <div style="min-width:260px">
              <b>Selling‚Ä¶</b> <span class="muted" id="sellingMsg">Customers are arriving.</span>
              <div class="mini">Costs were paid up-front. Now revenue comes in.</div>
            </div>
            <div class="meter">
              <div class="kpi"><div class="k">Customers</div><div class="v" id="kCustomers">0</div></div>
              <div class="kpi"><div class="k">Cups left</div><div class="v" id="kCupsLeft">‚Äî</div></div>
              <div class="kpi"><div class="k">Revenue</div><div class="v" id="kRevenue">$0</div></div>
            </div>
          </div>

          <div id="dayHint" class="hint hide"></div>
        </div>

        <!-- RESULT VIEW -->
        <div id="resultView" class="hide">
          <h2 id="resultTitle">Results</h2>
          <div id="profitBig" style="font-size:38px;font-weight:1000;letter-spacing:-.02em;margin:6px 0 6px;">$0.00</div>
          <div class="muted" id="resultNarrative">‚Äî</div>

          <div class="sep"></div>
          <div class="list" id="resultList"></div>

          <div id="lessonBox" class="hint"></div>

          <div class="row" style="margin-top:14px">
            <button class="primary" id="btnNext">Next Day</button>
            <button class="ghost hide" id="btnPlayAgain">Play Again</button>
            <button class="ok" id="btnCSV">Download CSV</button>
            <button class="ghost" id="btnPrint">Print Reflection</button>
          </div>

          <div id="summaryBox" class="card teacherPanel hide" style="margin-top:12px;">
            <h2>End-of-Run Summary</h2>
            <div class="list" id="summaryList"></div>
          </div>

          <div id="reflectionSheet" class="card hide" style="margin-top:12px;">
            <h2>Reflection Sheet</h2>

            <div class="pillRow" style="margin-top:6px">
              <div class="pill">üë§ Student: <b id="refName">‚Äî</b></div>
              <div class="pill">üè´ Class: <b id="refClass">‚Äî</b></div>
              <div class="pill">üë©üèΩ‚Äçüè´ Teacher: <b id="refTeacher">‚Äî</b></div>
              <div class="pill">üìÖ Days: <b id="refDays">‚Äî</b></div>
              <div class="pill">üíµ Final cash: <b id="refFinalCash">‚Äî</b></div>
              <div class="pill">üìà Total profit: <b id="refTotalProfit">‚Äî</b></div>
            </div>

            <div class="sep"></div>

            <div class="q">
              <label><b>1) What decision helped your profit the most? Why?</b></label>
              <textarea id="q1" style="width:100%;min-height:70px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background: rgba(0,0,0,.18);color:var(--text);padding:10px;outline:none;font-family:inherit;font-size:13px;"></textarea>
            </div>
            <div class="q" style="margin-top:10px;">
              <label><b>2) When did you waste cups or sell out? What will you change next time?</b></label>
              <textarea id="q2" style="width:100%;min-height:70px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background: rgba(0,0,0,.18);color:var(--text);padding:10px;outline:none;font-family:inherit;font-size:13px;"></textarea>
            </div>
            <div class="q" style="margin-top:10px;">
              <label><b>3) Explain: Revenue vs Profit (your own words)</b></label>
              <textarea id="q3" style="width:100%;min-height:70px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background: rgba(0,0,0,.18);color:var(--text);padding:10px;outline:none;font-family:inherit;font-size:13px;"></textarea>
            </div>

            <div class="callout" style="margin-top:10px;">
              <b>Definitions:</b> Revenue = price √ó cups sold ‚Ä¢ Profit = revenue ‚àí (COGS + marketing + fixed costs + spoilage penalty)
            </div>

            <div class="mini" style="margin-top:10px">Print (or Save as PDF). MVP does not upload answers anywhere.</div>
          </div>
        </div>

        <!-- TEACHER VIEW -->
        <div id="teacherView" class="hide">
          <h2>Teacher Dashboard</h2>
          <div class="muted">Analytics + class controls. Students keep the clean game flow.</div>

          <div class="sep"></div>

          <div class="card teacherPanel" style="padding:14px;">
            <div style="font-weight:950;">Class KPIs</div>
            <div class="list" id="teacherKPIs" style="margin-top:10px;"></div>
          </div>

          <div class="hint" id="teacherInsights" style="margin-top:12px"></div>

          <div class="row" style="margin-top:14px">
            <button class="ok" id="btnTeacherCSV">Download CSV</button>
            <button class="ghost" id="btnTeacherPrint">Print Reflection</button>
            <button class="ghost" id="btnBackToGame">Back to Game</button>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="card" id="historyCard">
        <h2>Scoreboard</h2>
        <div class="muted">This run is saved locally on this device.</div>
        <div class="sep"></div>
        <div class="list" id="history"></div>
        <div class="sep"></div>
        <div class="muted">
          <b>Teaches:</b> profit vs revenue, cost & margin, inventory waste, price sensitivity, demand changes, fixed costs, reputation, and iteration.
        </div>
      </div>

    </div>
  </div>

<script>
/** Lemonade Class ‚Äî single-file classroom MVP (Teacher PIN)
 *  REQUIRED in SAME directory:
 *   - logo.png (transparent)
 *   - logo-bg.jpg (optional fallback)
 */

const $ = (id) => document.getElementById(id);
const money = (n) => (n < 0 ? `-$${Math.abs(n).toFixed(2)}` : `$${n.toFixed(2)}`);
const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
const pct = (n) => `${(n*100).toFixed(0)}%`;
const safeDiv = (a,b) => b===0 ? 0 : a/b;

const STORE_KEY = "lemonade_class_mvp_teacher_pin_v3";
const SESSION_TEACHER_AUTH = "lc_teacher_authed";
const LOGO_PRIMARY = "./logo.png";
const LOGO_FALLBACK = "./logo-bg.jpg";

function setLogo(imgEl){
  imgEl.src = LOGO_PRIMARY;
  imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = LOGO_FALLBACK; };
}

const WEATHER = [
  { key:"Hot",   icon:"‚òÄÔ∏è", mult:1.35 },
  { key:"Mild",  icon:"üå§Ô∏è", mult:1.00 },
  { key:"Rainy", icon:"üåßÔ∏è", mult:0.60 },
];

const EVENTS = [
  { key:"None", icon:"‚Äî", mult:1.00, chance:0.50 },
  { key:"Street Fair", icon:"üé™", mult:1.40, chance:0.18 },
  { key:"Construction", icon:"üöß", mult:0.75, chance:0.16 },
  { key:"Sports Game Nearby", icon:"üèÄ", mult:1.20, chance:0.16 },
];

const TRAFFIC = {
  low:  { label:"Low",  mult:0.85 },
  med:  { label:"Medium", mult:1.00 },
  high: { label:"High", mult:1.18 },
};

const MIX = {
  price:       { label:"Price-sensitive", elasticity: 1.25 },
  balanced:    { label:"Balanced", elasticity: 1.00 },
  convenience: { label:"Convenience-focused", elasticity: 0.80 },
};

const QUALITY = {
  cheap:    { label:"Cheap",    costMult: 0.85, repDelta: -0.03 },
  standard: { label:"Standard", costMult: 1.00, repDelta:  0.00 },
  premium:  { label:"Premium",  costMult: 1.20, repDelta:  0.03 },
};

function pickWeighted(items){
  const r = Math.random(); let s = 0;
  for(const it of items){ s += it.chance; if(r <= s) return it; }
  return items[items.length-1];
}
function randBetween(a,b){ return a + Math.random()*(b-a); }

/* Tougher demand + diminishing marketing (prevents ‚Äúautopilot profit‚Äù) */
function marketingFactor(mkt){
  const x = clamp(mkt,0,20);
  return 1 + 0.22 * (1 - Math.exp(-x/6)); // max ~ +22%
}
function priceFactor(price, difficulty, elasticity){
  const sweet = 1.75;
  const delta = price - sweet;
  const harsh = (difficulty === "competitive") ? 1.35 : (difficulty === "guided" ? 0.85 : 1.05);
  const e = elasticity ?? 1.0;

  if(delta > 0){
    const f = 1 - (0.28 * harsh * e) * delta;
    return clamp(f, 0.10, 1.00);
  } else {
    const f = 1 + (0.08 * (1/harsh) * (1/e)) * Math.abs(delta);
    return clamp(f, 0.70, 1.20);
  }
}
function competitorFactor(price, rivalPrice, difficulty){
  const d = price - rivalPrice;
  const harsh = (difficulty === "competitive") ? 1.1 : (difficulty === "guided" ? 0.9 : 1.0);
  if(d > 0){
    const f = 1 - (0.22 * harsh) * d;
    return clamp(f, 0.35, 1.00);
  } else {
    const f = 1 + 0.10 * Math.abs(d);
    return clamp(f, 0.70, 1.25);
  }
}
function dailyDemand({weatherMult, eventMult, price, mkt, rivalPrice, difficulty, trafficMult, elasticity}){
  const base = 56; // slightly lower
  const pf = priceFactor(price, difficulty, elasticity);
  const mf = marketingFactor(mkt);
  const cf = competitorFactor(price, rivalPrice, difficulty);
  const noise = randBetween(0.82, 1.18);
  return Math.max(0, Math.round(base * weatherMult * eventMult * trafficMult * pf * mf * cf * noise));
}
function dailyFixedCost(difficulty, trafficKey){
  const base = (difficulty === "competitive") ? 22 : (difficulty === "guided" ? 10 : 16);
  const trafficMult = (trafficKey === "high") ? 1.15 : (trafficKey === "low" ? 0.90 : 1.0);
  return +(base * trafficMult).toFixed(2);
}

/* Math audit: guarantees everything is consistent */
function mathAuditDay(record, cogsPerCup){
  const revenue2 = +(record.cupsSold * record.price).toFixed(2);
  const cost2    = +(record.cupsMade * cogsPerCup).toFixed(2);
  const waste2   = Math.max(0, record.cupsMade - record.cupsSold);
  const wasteCost2 = +(waste2 * cogsPerCup).toFixed(2);
  const net2     = +(revenue2 - cost2 - record.marketing - record.fixedCost - record.spoilagePenalty).toFixed(2);

  const ok =
    revenue2 === record.revenue &&
    cost2 === record.cost &&
    waste2 === record.waste &&
    wasteCost2 === record.wasteCost &&
    net2 === record.netProfit;

  return { ok, expected: { revenue2, cost2, waste2, wasteCost2, net2 } };
}

function lessonFor({profit, wasteCost, missedSales, fixedCost, reputationAfter}){
  if(profit < 0) return `You lost money today. Fixed costs were ${money(fixedCost)}. Adjust price/cups to beat overhead.`;
  if(reputationAfter < 0.40) return "Your reputation dropped. Selling out too much, wasting a lot, or poor quality can reduce future demand.";
  if(wasteCost >= 8) return `High waste cost (${money(wasteCost)}). Try making fewer cups or raising price slightly.`;
  if(missedSales >= 12) return `You sold out and missed about ${missedSales} sales. Make more cups or raise price.`;
  return "Strong day. You matched price + inventory to demand and protected reputation.";
}
function narrativeFor({weatherKey, eventKey, price, rivalPrice, soldOut, repMult}){
  if(soldOut) return `Sold out on a ${weatherKey} day. Rival was ${money(rivalPrice)}. Reputation effect: √ó${repMult.toFixed(2)} demand.`;
  return `Conditions: ${weatherKey}${eventKey!=="None" ? " + "+eventKey : ""}. Your price was ${money(price)}. Reputation effect: √ó${repMult.toFixed(2)} demand.`;
}

function freshState(){
  return {
    view:"start",
    // settings
    userRole:"student",
    lockStudentSettings:false,
    playerName:"",
    classCode:"",
    teacherName:"",
    explainMode:"on",
    daysTotal:7,
    difficulty:"standard",
    startingCash:100,
    cogsPerCup:0.50,
    costMode:"simple",
    scenarioTraffic:"med",
    scenarioMix:"balanced",
    teacherPin:"1111",

    // run
    day:1,
    cash:100,
    reputation: 0.50, // 0..1
    todays:null,
    history:[]
  };
}

let state = loadState() ?? freshState();

function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
function loadState(){
  try{ const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; }
  catch(e){ return null; }
}
function clearState(){
  localStorage.removeItem(STORE_KEY);
  sessionStorage.removeItem(SESSION_TEACHER_AUTH);
  state = freshState();
  render();
}
function isTeacherAuthed(){
  return sessionStorage.getItem(SESSION_TEACHER_AUTH) === "1";
}
function setTeacherAuthed(on){
  if(on) sessionStorage.setItem(SESSION_TEACHER_AUTH, "1");
  else sessionStorage.removeItem(SESSION_TEACHER_AUTH);
}

function applyRoleTheme(){
  document.body.dataset.role = state.userRole || "student";
}

function show(view){
  state.view = view;
  $("startView").classList.toggle("hide", view !== "start");
  $("dayView").classList.toggle("hide", view !== "day");
  $("resultView").classList.toggle("hide", view !== "result");
  $("teacherView").classList.toggle("hide", view !== "teacher");
  saveState();
}

function setHeader(){
  $("cashPill").textContent = money(state.cash);
  $("dayPill").textContent = (state.view === "start") ? "‚Äî" : `${Math.min(state.day, state.daysTotal)} / ${state.daysTotal}`;
  $("repPill").textContent = `${Math.round(clamp(state.reputation ?? 0.5,0,1) * 100)}/100`;
  $("explainPill").textContent = (state.explainMode === "on") ? "On" : "Off";
  $("roleBadge").textContent = (state.userRole==="teacher") ? "TEACHER" : "STUDENT";
}

function canStudentOpenSettings(){
  if(state.userRole === "teacher") return true;
  return !state.lockStudentSettings;
}

function enforceRoleUI(){
  $("btnTeacher").classList.toggle("hide", state.userRole !== "teacher");

  $("btnToggleSettings").classList.toggle("hide", !canStudentOpenSettings());

  $("settingsTitle").textContent = (state.userRole==="teacher") ? "Class Controls" : "Settings";

  // teacher-only fields
  $("lockWrap").classList.toggle("hide", state.userRole !== "teacher");
  $("pinWrap").classList.toggle("hide", state.userRole !== "teacher");
}

function renderHistory(){
  const box = $("history");
  box.innerHTML = "";
  if(state.history.length === 0){
    box.innerHTML = `<div class="li"><span>No days yet</span><b>‚Äî</b></div>`;
    return;
  }
  state.history.slice().reverse().forEach(h => {
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>Day ${h.day} ‚Ä¢ ${h.weather.icon} ${h.weather.key}</span><b class="${h.netProfit>=0?'good':'bad'}">${money(h.netProfit)}</b>`;
    box.appendChild(div);
  });
}

function maybeShowResume(){
  const saved = loadState();
  const showBtns = !!saved && state.view === "start" && (saved.history?.length ?? 0) > 0;
  $("btnResume").classList.toggle("hide", !showBtns);
  $("btnClear").classList.toggle("hide", !showBtns);
}

function newDayContext(){
  const weather = WEATHER[Math.floor(Math.random()*WEATHER.length)];
  const event = pickWeighted(EVENTS);
  const rivalPrice = clamp(randBetween(1.10, 2.90), 0.75, 3.25);
  state.todays = { weather, event, rivalPrice };
  saveState();
}

/* PIN modal */
let pendingTeacherAction = null;

function openPinModal(onSuccess){
  pendingTeacherAction = onSuccess;
  $("pinInput").value = "";
  $("pinErr").style.display = "none";
  $("pinModalBack").style.display = "grid";
  setTimeout(()=> $("pinInput").focus(), 50);
}
function closePinModal(){
  $("pinModalBack").style.display = "none";
  pendingTeacherAction = null;
}
function submitPin(){
  const pin = ($("pinInput").value || "").trim();
  const expected = String(state.teacherPin || "1111").padStart(4,"0");

  if(!/^\d{4}$/.test(pin)){
    $("pinErr").textContent = "PIN must be 4 digits.";
    $("pinErr").style.display = "block";
    return;
  }
  if(pin !== expected){
    $("pinErr").textContent = "Incorrect PIN.";
    $("pinErr").style.display = "block";
    return;
  }

  const remember = $("pinRemember").value === "yes";
  setTeacherAuthed(remember);

  closePinModal();
  if(typeof pendingTeacherAction === "function") pendingTeacherAction();
}

function requestTeacherMode(after){
  // if already authed this tab, allow immediately
  if(isTeacherAuthed()){
    after();
    return;
  }
  openPinModal(after);
}

function syncInputs(){
  $("cupsVal").textContent = `${$("cups").value}`;
  $("priceVal").textContent = money(parseFloat($("price").value));
  $("mktVal").textContent = `$${parseInt($("mkt").value,10)}`;

  const cups = parseInt($("cups").value,10);
  const mkt = parseInt($("mkt").value,10);

  // cost per cup (may include quality multiplier)
  const baseCogs = Number(state.cogsPerCup ?? 0.50);
  const qualityKey = $("quality") ? $("quality").value : "standard";
  const qMult = (state.costMode === "advanced") ? (QUALITY[qualityKey]?.costMult ?? 1.0) : 1.0;
  const cogs = +(baseCogs * qMult).toFixed(2);

  const fixed = dailyFixedCost(state.difficulty, state.scenarioTraffic);
  const upfront = +(cups * cogs + mkt + fixed).toFixed(2);

  $("cogsTag").textContent = money(cogs);
  $("fixedTag").textContent = money(fixed);
  $("upfrontSpendVal").textContent = money(upfront);

  if(state.explainMode === "on"){
    $("explainTips").classList.remove("hide");
    $("explainTips").textContent =
      "Up-front spend happens BEFORE selling (COGS + marketing + fixed cost). Profit depends on demand, price, waste, and reputation.";
  } else {
    $("explainTips").classList.add("hide");
  }
}

function renderStart(){
  $("playerName2").value = state.playerName || "";
  $("classCode2").value = state.classCode || "";
  $("teacherName2").value = state.teacherName || "";

  $("playerName").value = state.playerName || "";
  $("classCode").value = state.classCode || "";
  $("teacherName").value = state.teacherName || "";
  $("explainMode").value = state.explainMode || "on";
  $("gameLen").value = String(state.daysTotal || 7);
  $("difficulty").value = state.difficulty || "standard";
  $("startingCash").value = String(state.startingCash || 100);
  $("cogsPerCup").value = String(state.cogsPerCup ?? 0.50);
  $("costMode").value = state.costMode || "simple";
  $("scenarioTraffic").value = state.scenarioTraffic || "med";
  $("scenarioMix").value = state.scenarioMix || "balanced";

  $("userRole").value = state.userRole || "student";
  $("userRole2").value = state.userRole || "student";
  $("lockStudentSettings").value = state.lockStudentSettings ? "yes" : "no";
  $("teacherPin").value = String(state.teacherPin || "1111");

  maybeShowResume();
  enforceRoleUI();
}

function renderDay(){
  if(!state.todays) newDayContext();
  const { weather, event, rivalPrice } = state.todays;

  $("dayTitle").textContent = `Day ${state.day} ‚Äî Decisions`;
  $("wxPill").textContent = `${weather.icon} ${weather.key}`;
  $("eventPill").textContent = `${event.icon} ${event.key}`;
  $("rivalPill").textContent = money(rivalPrice);

  $("trafficPill").textContent = TRAFFIC[state.scenarioTraffic].label;
  $("mixPill").textContent = MIX[state.scenarioMix].label;

  // show/hide quality choice
  $("qualityWrap").classList.toggle("hide", state.costMode !== "advanced");

  $("cups").value = 80;
  $("price").value = 2.00;
  $("mkt").value = 0;
  if($("quality")) $("quality").value = "standard";

  $("sellingBox").classList.add("hide");
  $("dayHint").classList.add("hide");
  $("dayHint").textContent = "";
  $("sellingMsg").textContent = "Customers are arriving.";

  syncInputs();
}

function computeTotals(){
  const totalRevenue = state.history.reduce((s,h)=>s+h.revenue,0);
  const totalCOGS = state.history.reduce((s,h)=>s+h.cost,0);
  const totalMkt = state.history.reduce((s,h)=>s+h.marketing,0);
  const totalFixed = state.history.reduce((s,h)=>s+h.fixedCost,0);
  const totalSpoil = state.history.reduce((s,h)=>s+h.spoilagePenalty,0);
  const totalProfit = state.history.reduce((s,h)=>s+h.netProfit,0);
  const totalMade = state.history.reduce((s,h)=>s+h.cupsMade,0);
  const totalSold = state.history.reduce((s,h)=>s+h.cupsSold,0);
  const totalWaste = state.history.reduce((s,h)=>s+h.waste,0);
  const missed = state.history.reduce((s,h)=>s+h.missedSales,0);

  const gm = safeDiv((totalRevenue - totalCOGS), totalRevenue);
  const pm = safeDiv(totalProfit, totalRevenue);

  const best = state.history.reduce((a,b)=> b.netProfit>a.netProfit?b:a, state.history[0]);
  const worst = state.history.reduce((a,b)=> b.netProfit<a.netProfit?b:a, state.history[0]);

  const mathOK = state.history.every(h => h.mathOk !== false);

  return { totalRevenue,totalCOGS,totalMkt,totalFixed,totalSpoil,totalProfit,totalMade,totalSold,totalWaste,missed,gm,pm,best,worst,mathOK };
}

function fillSummary(){
  const t = computeTotals();
  const avgProfit = t.totalProfit / state.history.length;

  const box = $("summaryList");
  box.innerHTML = "";
  const rows = [
    ["Math Verified", t.mathOK ? `<span class="good">‚úÖ All days verified</span>` : `<span class="bad">‚ùå Needs review</span>`],
    ["Total Revenue", money(t.totalRevenue)],
    ["Total COGS", money(t.totalCOGS)],
    ["Total Marketing", money(t.totalMkt)],
    ["Total Fixed Costs", money(t.totalFixed)],
    ["Total Spoilage Penalty", money(t.totalSpoil)],
    ["Total Profit", `<span class="${t.totalProfit>=0?'good':'bad'}">${money(t.totalProfit)}</span>`],
    ["Gross Margin", pct(t.gm)],
    ["Profit Margin", pct(t.pm)],
    ["Cups Made", String(t.totalMade)],
    ["Cups Sold", String(t.totalSold)],
    ["Cups Wasted", String(t.totalWaste)],
    ["Missed Sales", String(t.missed)],
    ["Avg Profit / Day", `<span class="${avgProfit>=0?'good':'bad'}">${money(avgProfit)}</span>`],
    ["Best Day", `Day ${t.best.day} (${money(t.best.netProfit)})`],
    ["Worst Day", `Day ${t.worst.day} (${money(t.worst.netProfit)})`],
  ];
  rows.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${k}</span><b>${v}</b>`;
    box.appendChild(div);
  });
}

function fillReflection(){
  const finalCash = state.cash;
  const totalProfit = finalCash - state.startingCash;

  $("refName").textContent = state.playerName || "Student";
  $("refClass").textContent = state.classCode || "‚Äî";
  $("refTeacher").textContent = state.teacherName || "‚Äî";
  $("refDays").textContent = String(state.daysTotal);
  $("refFinalCash").textContent = money(finalCash);
  $("refTotalProfit").textContent = money(totalProfit);

  if(state.history.length){
    const best = state.history.reduce((a,b)=> b.netProfit>a.netProfit?b:a, state.history[0]);
    const worst = state.history.reduce((a,b)=> b.netProfit<a.netProfit?b:a, state.history[0]);
    if(!$("q1").value) $("q1").value = `My most profitable day was Day ${best.day}. I matched my price and cups to demand and protected reputation.`;
    if(!$("q2").value) $("q2").value = `On Day ${worst.day}, I wasted cups or sold out. Next time I will adjust cups/price and watch fixed costs.`;
    if(!$("q3").value) $("q3").value = `Revenue is money collected. Profit is money left after costs like COGS, marketing, fixed costs, and spoilage.`;
  }
}

function renderResult(last){
  $("resultTitle").textContent = (state.day > state.daysTotal) ? "Final Results" : `Day ${last.day} Results`;

  const big = $("profitBig");
  big.textContent = money(last.netProfit);
  big.style.color = last.netProfit>=0 ? "var(--good)" : "var(--bad)";

  $("resultNarrative").textContent = last.narrative;

  const grossMargin = safeDiv((last.revenue - last.cost), last.revenue);
  const profitMargin = safeDiv(last.netProfit, last.revenue);

  const list = $("resultList");
  list.innerHTML = "";
  const rows = [
    ["Math check", last.mathOk ? `<span class="good">‚úÖ Verified</span>` : `<span class="bad">‚ùå Check failed</span>`],
    ["Demand (raw ‚Üí rep)", `${last.demandRaw} ‚Üí ${last.demandEff}`],
    ["Reputation (after)", `${Math.round(last.reputationAfter*100)}/100`],
    ["Customers served", String(last.cupsSold)],
    ["Cups made", String(last.cupsMade)],
    ["Missed sales", String(last.missedSales)],
    ["Cups wasted", String(last.waste)],
    ["Waste cost", money(last.wasteCost)],
    ["Revenue", money(last.revenue)],
    ["COGS", money(last.cost)],
    ["Marketing", money(last.marketing)],
    ["Fixed cost", money(last.fixedCost)],
    ["Spoilage penalty", money(last.spoilagePenalty)],
    ["Net profit", `<span class="${last.netProfit>=0?'good':'bad'}">${money(last.netProfit)}</span>`],
    ["Gross margin", pct(grossMargin)],
    ["Profit margin", pct(profitMargin)],
    ["Cash balance", money(last.cashAfter)],
  ];
  rows.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${k}</span><b>${v}</b>`;
    list.appendChild(div);
  });

  $("lessonBox").textContent = "üìå " + last.lesson;

  const finished = state.day > state.daysTotal;
  $("btnNext").classList.toggle("hide", finished);
  $("btnPlayAgain").classList.toggle("hide", !finished);

  $("summaryBox").classList.toggle("hide", !finished);
  $("reflectionSheet").classList.toggle("hide", !finished);

  if(finished){
    fillSummary();
    fillReflection();
  }

  $("btnPrint").disabled = !finished;
}

function bailoutIfNeeded(){
  if(state.cash >= 0) return;
  if(state.difficulty === "competitive") return;
  const loan = Math.abs(state.cash) + 25;
  state.cash += loan;
  state._bailoutNote = `Emergency bailout: you received ${money(loan)} so you can finish the simulation.`;
}

function resetDayInputs(){
  $("cups").value = 80;
  $("price").value = 2.00;
  $("mkt").value = 0;
  if($("quality")) $("quality").value = "standard";
  syncInputs();
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function sellDay(){
  const cupsMade = parseInt($("cups").value, 10);
  const price = parseFloat($("price").value);
  const marketing = parseInt($("mkt").value, 10);

  if(!state.todays) newDayContext();
  const { weather, event, rivalPrice } = state.todays;

  const trafficMult = TRAFFIC[state.scenarioTraffic].mult;
  const elasticity = MIX[state.scenarioMix].elasticity;

  const baseCogs = Number(state.cogsPerCup ?? 0.50);
  const qualityKey = ($("quality") && state.costMode === "advanced") ? $("quality").value : "standard";
  const q = QUALITY[qualityKey] || QUALITY.standard;
  const cogsPerCup = +(baseCogs * (state.costMode === "advanced" ? q.costMult : 1.0)).toFixed(2);

  const demandRaw = dailyDemand({
    weatherMult: weather.mult,
    eventMult: event.mult,
    price,
    mkt: marketing,
    rivalPrice,
    difficulty: state.difficulty,
    trafficMult,
    elasticity
  });

  // Reputation affects demand strongly
  const rep = clamp(state.reputation ?? 0.50, 0, 1);
  const repMult = 0.75 + rep * 0.60; // 0.75..1.35
  const demandEff = Math.max(0, Math.round(demandRaw * repMult));

  const cupsSold = Math.min(cupsMade, demandEff);
  const missedSales = Math.max(0, demandEff - cupsSold);
  const waste = Math.max(0, cupsMade - cupsSold);

  const revenue = +(cupsSold * price).toFixed(2);
  const cost = +(cupsMade * cogsPerCup).toFixed(2);
  const wasteCost = +(waste * cogsPerCup).toFixed(2);

  const fixedCost = dailyFixedCost(state.difficulty, state.scenarioTraffic);
  const spoilagePenalty = +(waste * cogsPerCup * 0.35).toFixed(2); // extra sting for waste

  const upfrontSpend = +(cost + marketing + fixedCost).toFixed(2);

  // Need cash up-front
  if(upfrontSpend > state.cash){
    $("dayHint").classList.remove("hide");
    $("dayHint").textContent =
      `You need ${money(upfrontSpend)} (COGS + marketing + fixed cost), but you only have ${money(state.cash)}. Lower cups or marketing.`;
    return;
  }

  // Pay up-front
  state.cash = +(state.cash - upfrontSpend).toFixed(2);
  saveState();
  setHeader();

  // Selling phase UI
  $("sellingBox").classList.remove("hide");
  $("btnSell").disabled = true;
  $("sellingMsg").textContent = `Paid ${money(upfrontSpend)} up-front. Selling now...`;

  $("kCustomers").textContent = "0";
  $("kCupsLeft").textContent = String(cupsMade);
  $("kRevenue").textContent = "$0";

  const durationMs = 8000;
  const steps = 28;
  const stepMs = Math.round(durationMs/steps);

  for(let i=1;i<=steps;i++){
    const t = i/steps;
    const shownCustomers = Math.round(demandEff * t);
    const shownSold = Math.min(cupsMade, Math.round(cupsSold * t));
    const shownLeft = Math.max(0, cupsMade - shownSold);
    const shownRevenue = +(shownSold * price).toFixed(2);

    $("kCustomers").textContent = String(shownCustomers);
    $("kCupsLeft").textContent = String(shownLeft);
    $("kRevenue").textContent = money(shownRevenue);

    if(shownLeft === 0 && cupsMade > 0){
      $("sellingMsg").textContent = "Sold out! Some customers left for the rival.";
      await sleep(650);
      break;
    }
    await sleep(stepMs);
  }

  $("btnSell").disabled = false;
  $("sellingBox").classList.add("hide");

  // Add revenue after selling; subtract spoilage penalty
  state.cash = +(state.cash + revenue - spoilagePenalty).toFixed(2);

  const netProfit = +(revenue - upfrontSpend - spoilagePenalty).toFixed(2);

  // Reputation update
  const soldOut = (cupsSold === cupsMade && demandEff > cupsMade && cupsMade > 0);
  const wasteRate = cupsMade ? (waste / cupsMade) : 0;

  let repDelta = 0;

  // quality nudges rep (advanced mode only)
  if(state.costMode === "advanced") repDelta += q.repDelta;

  // pricing: too high hurts; fair helps slightly
  if(price > 2.50) repDelta -= 0.05;
  else if(price >= 1.25 && price <= 2.25) repDelta += 0.02;

  // stockouts hurt future trust
  if(soldOut) repDelta -= 0.06;

  // big waste looks sloppy
  if(wasteRate >= 0.25) repDelta -= 0.05;
  else if(wasteRate <= 0.10 && !soldOut) repDelta += 0.02;

  // heavy marketing cannot fully replace trust
  if(marketing >= 10) repDelta += 0.01;

  state.reputation = clamp((state.reputation ?? 0.50) + repDelta, 0, 1);

  bailoutIfNeeded();

  const narrative = narrativeFor({weatherKey: weather.key, eventKey: event.key, price, rivalPrice, soldOut, repMult});
  const lesson = lessonFor({profit: netProfit, wasteCost, missedSales, fixedCost, reputationAfter: state.reputation});

  const record = {
    day: state.day,
    weather, event, rivalPrice,
    cupsMade, price, marketing,
    quality: qualityKey,
    demandRaw, demandEff,
    cupsSold, missedSales,
    waste, wasteCost,
    revenue,
    cost,
    fixedCost,
    spoilagePenalty,
    netProfit,
    cashAfter: state.cash,
    reputationAfter: state.reputation,
    repDelta,
    narrative,
    lesson
  };

  // --- Math audit ---
  const audit = mathAuditDay(record, cogsPerCup);
  record.mathOk = audit.ok;
  record.mathExpected = audit.expected;
  if(!audit.ok){
    console.warn("MATH AUDIT FAILED", { record, expected: audit.expected, cogsPerCup });
  }

  state.history.push(record);

  state.day += 1;
  state.todays = null;

  saveState();
  renderHistory();
  show("result");
  setHeader();
  renderResult(record);

  if(state._bailoutNote){
    $("lessonBox").textContent = "üìå " + record.lesson + " ‚Äî " + state._bailoutNote;
    delete state._bailoutNote;
    saveState();
  }

  if(state.day > state.daysTotal){
    const totalProfit = +(state.cash - state.startingCash).toFixed(2);
    $("resultNarrative").textContent = (totalProfit >= 0)
      ? `Finish strong. You grew ${money(state.startingCash)} into ${money(state.cash)}. What would you reinvest in?`
      : `You finished at ${money(state.cash)}. What one change would make you profitable next time?`;
  }
}

function nextDay(){
  if(state.day > state.daysTotal) return;
  show("day");
  renderDay();
  setHeader();
}

function playAgain(){
  const keepSettings = {
    userRole: state.userRole,
    lockStudentSettings: state.lockStudentSettings,
    playerName: state.playerName,
    classCode: state.classCode,
    teacherName: state.teacherName,
    explainMode: state.explainMode,
    daysTotal: state.daysTotal,
    difficulty: state.difficulty,
    startingCash: state.startingCash,
    cogsPerCup: state.cogsPerCup,
    costMode: state.costMode,
    scenarioTraffic: state.scenarioTraffic,
    scenarioMix: state.scenarioMix,
    teacherPin: state.teacherPin,
  };
  state = freshState();
  Object.assign(state, keepSettings);
  state.day = 1;
  state.cash = state.startingCash;
  state.reputation = 0.50;
  state.history = [];
  state.todays = null;
  saveState();
  show("start");
  renderStart();
  setHeader();
  renderHistory();
}

function restartRun(){
  state.day = 1;
  state.cash = state.startingCash;
  state.reputation = 0.50;
  state.history = [];
  state.todays = null;
  saveState();
  show("start");
  renderStart();
  setHeader();
  renderHistory();
}

function goHome(){
  show("start");
  renderStart();
  setHeader();
  renderHistory();
}

function openSettings(){
  if(!canStudentOpenSettings()) return;
  $("settingsDrawer").classList.remove("hide");
}
function closeSettings(){ $("settingsDrawer").classList.add("hide"); }

function setHomeTab(which){
  ["learn","play","teach"].forEach(t=>{
    $("tab"+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle("active", t===which);
    $("home"+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle("hide", t!==which);
  });
}

function resumeGame(){
  const loaded = loadState();
  if(loaded){ state = loaded; render(); }
}

function applySettings(restartRunFlag){
  const wantedRole = $("userRole").value;

  // If trying to switch to teacher, require PIN
  const doApply = () => {
    state.userRole = wantedRole;
    state.explainMode = $("explainMode").value;

    state.playerName = ($("playerName").value || "").trim();
    state.classCode = ($("classCode").value || "").trim();
    state.teacherName = ($("teacherName").value || "").trim();

    state.lockStudentSettings = ($("lockStudentSettings").value === "yes");

    state.daysTotal = parseInt($("gameLen").value, 10);
    state.difficulty = $("difficulty").value;
    state.startingCash = parseFloat($("startingCash").value);
    state.cogsPerCup = parseFloat($("cogsPerCup").value);
    state.costMode = $("costMode").value;
    state.scenarioTraffic = $("scenarioTraffic").value;
    state.scenarioMix = $("scenarioMix").value;

    // Teacher-only: set PIN if in teacher role
    if(state.userRole === "teacher"){
      const pin = ($("teacherPin").value || "").trim();
      if(/^\d{4}$/.test(pin)) state.teacherPin = pin;
      else state.teacherPin = String(state.teacherPin || "1111").padStart(4,"0");
    }

    if(restartRunFlag){
      state.day = 1;
      state.cash = state.startingCash;
      state.reputation = 0.50;
      state.history = [];
      state.todays = null;
      saveState();
      show("day");
      renderDay();
    } else {
      saveState();
    }

    closeSettings();
    render();
  };

  if(wantedRole === "teacher" && state.userRole !== "teacher"){
    requestTeacherMode(doApply);
  } else {
    doApply();
  }
}

function startGameFromHome(){
  const wantedRole = $("userRole2").value;

  const doStart = () => {
    state.userRole = wantedRole;

    state.playerName = ($("playerName2").value || "").trim() || "Student";
    state.classCode = ($("classCode2").value || "").trim();
    state.teacherName = ($("teacherName2").value || "").trim();

    const preset = $("preset").value;
    state.difficulty = preset;
    state.daysTotal = 7;
    state.explainMode = "on";
    state.startingCash = (preset === "guided") ? 150 : (preset === "competitive" ? 100 : 100);
    state.cogsPerCup = 0.50;
    state.costMode = "simple";
    state.scenarioTraffic = "med";
    state.scenarioMix = "balanced";

    if(state.userRole === "teacher"){
      // common teacher default
      state.lockStudentSettings = true;
    }

    state.day = 1;
    state.cash = state.startingCash;
    state.reputation = 0.50;
    state.history = [];
    state.todays = null;

    saveState();
    show("day");
    renderDay();
    render();
  };

  if(wantedRole === "teacher"){
    requestTeacherMode(doStart);
  } else {
    doStart();
  }
}

function toCSV(){
  const headers = [
    "userRole","lockStudentSettings",
    "studentName","classCode","teacherName",
    "daysTotal","difficulty","explainMode",
    "startingCash","cogsPerCup","costMode",
    "scenarioTraffic","scenarioMix",
    "day","weather","event","rivalPrice",
    "quality","demandRaw","demandEff",
    "cupsMade","price","marketing",
    "cupsSold","missedSales","waste","wasteCost",
    "reputationAfter","repDelta",
    "revenue","cogsCost","fixedCost","spoilagePenalty",
    "netProfit","cashAfter","mathOk"
  ];
  const esc = (v) => {
    const s = String(v ?? "");
    if(s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
    return s;
  };

  const lines = [headers.join(",")];
  for(const h of state.history){
    const row = [
      state.userRole, state.lockStudentSettings ? "yes" : "no",
      state.playerName, state.classCode, state.teacherName,
      state.daysTotal, state.difficulty, state.explainMode,
      state.startingCash, state.cogsPerCup, state.costMode,
      state.scenarioTraffic, state.scenarioMix,
      h.day, h.weather.key, h.event.key, h.rivalPrice.toFixed(2),
      h.quality ?? "standard", h.demandRaw, h.demandEff,
      h.cupsMade, h.price.toFixed(2), h.marketing,
      h.cupsSold, h.missedSales, h.waste, h.wasteCost.toFixed(2),
      (h.reputationAfter ?? 0.5).toFixed(2), (h.repDelta ?? 0).toFixed(2),
      h.revenue.toFixed(2), h.cost.toFixed(2), h.fixedCost.toFixed(2), h.spoilagePenalty.toFixed(2),
      h.netProfit.toFixed(2), h.cashAfter.toFixed(2),
      h.mathOk ? "true" : "false"
    ].map(esc);
    lines.push(row.join(","));
  }
  const totalProfit = +(state.cash - state.startingCash).toFixed(2);
  lines.push("");
  lines.push(`Final Cash,${state.cash.toFixed(2)}`);
  lines.push(`Total Profit,${totalProfit.toFixed(2)}`);
  return lines.join("\n");
}
function downloadCSV(){
  const csv = toCSV();
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (state.playerName || "student").replace(/[^a-z0-9_-]/gi,"_");
  const safeClass = (state.classCode || "class").replace(/[^a-z0-9_-]/gi,"_");
  a.href = url;
  a.download = `lemonade_class_${safeClass}_${safeName}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function printReflection(){
  $("summaryBox").classList.remove("hide");
  $("reflectionSheet").classList.remove("hide");
  window.print();
}

/* Teacher dashboard rendering */
function renderTeacherDashboard(){
  const box = $("teacherKPIs");
  const insights = $("teacherInsights");
  box.innerHTML = "";

  if(state.history.length === 0){
    box.innerHTML = `<div class="li"><span>No data yet</span><b>Play at least 1 day</b></div>`;
    insights.textContent = "Tip: Pause after Day 1 and ask students to explain their profit using costs + demand + reputation.";
    return;
  }

  const t = computeTotals();
  const wasteRate = t.totalMade ? (t.totalWaste / t.totalMade) : 0;
  const selloutDays = state.history.filter(h=>h.missedSales>0 && h.waste===0).length;
  const wasteDays = state.history.filter(h=>h.waste>0).length;
  const avgProfit = t.totalProfit / state.history.length;

  const rows = [
    ["Math Verified", t.mathOK ? `<span class="good">‚úÖ All days verified</span>` : `<span class="bad">‚ùå Needs review</span>`],
    ["Total Profit", `<span class="${t.totalProfit>=0?'good':'bad'}">${money(t.totalProfit)}</span>`],
    ["Avg Profit / Day", `<span class="${avgProfit>=0?'good':'bad'}">${money(avgProfit)}</span>`],
    ["Waste Rate", pct(wasteRate)],
    ["Sell-out Days", `${selloutDays} / ${state.history.length}`],
    ["Waste Days", `${wasteDays} / ${state.history.length}`],
    ["Total Fixed Costs", money(t.totalFixed)],
    ["Best Day", `Day ${t.best.day} (${money(t.best.netProfit)})`],
    ["Worst Day", `Day ${t.worst.day} (${money(t.worst.netProfit)})`],
  ];
  rows.forEach(([k,v])=>{
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${k}</span><b>${v}</b>`;
    box.appendChild(div);
  });

  if(wasteRate >= 0.20){
    insights.textContent = "Insight: Students are overproducing. Coach them to reduce cups or raise price slightly and compare profit vs waste tomorrow.";
  } else if(selloutDays >= Math.ceil(state.history.length/2)){
    insights.textContent = "Insight: Students are selling out often. Coach them to increase cups or raise price and watch how reputation changes demand.";
  } else {
    insights.textContent = "Insight: Strong balance. Ask students to justify decisions using overhead, reputation, and margin‚Äînot just profit.";
  }
}

function openTeacher(){
  requestTeacherMode(() => {
    state.userRole = "teacher";
    saveState();
    show("teacher");
    renderTeacherDashboard();
    setHeader();
    enforceRoleUI();
    applyRoleTheme();
  });
}

function render(){
  applyRoleTheme();
  setHeader();
  enforceRoleUI();
  renderHistory();

  if(state.view === "teacher"){
    renderTeacherDashboard();
  } else if(state.view === "result" && state.history.length){
    show("result");
    renderResult(state.history[state.history.length - 1]);
  } else if(state.view === "day"){
    show("day");
    renderDay();
  } else {
    show("start");
    renderStart();
  }

  applyRoleTheme();
  setHeader();
  enforceRoleUI();
  renderHistory();
  maybeShowResume();
}

/* Events */
$("cups").addEventListener("input", syncInputs);
$("price").addEventListener("input", syncInputs);
$("mkt").addEventListener("input", syncInputs);
$("quality")?.addEventListener("change", syncInputs);

$("btnStart").addEventListener("click", startGameFromHome);
$("btnResume").addEventListener("click", resumeGame);
$("btnClear").addEventListener("click", clearState);

$("btnSell").addEventListener("click", sellDay);
$("btnResetDay").addEventListener("click", resetDayInputs);

$("btnNext").addEventListener("click", nextDay);
$("btnPlayAgain").addEventListener("click", playAgain);

$("btnCSV").addEventListener("click", downloadCSV);
$("btnPrint").addEventListener("click", printReflection);

$("btnHome").addEventListener("click", goHome);
$("btnRestart").addEventListener("click", restartRun);

$("btnTeacher").addEventListener("click", openTeacher);
$("btnTeacherCSV").addEventListener("click", downloadCSV);
$("btnTeacherPrint").addEventListener("click", printReflection);
$("btnBackToGame").addEventListener("click", () => {
  if(state.history.length) show("result"); else show("day");
  render();
});

$("btnToggleSettings").addEventListener("click", () => {
  if($("settingsDrawer").classList.contains("hide")) openSettings();
  else closeSettings();
});
$("btnCloseSettings").addEventListener("click", closeSettings);

$("btnApplySettings").addEventListener("click", () => applySettings(true));
$("btnSaveSettings").addEventListener("click", () => applySettings(false));

$("tabLearn").addEventListener("click", ()=>setHomeTab("learn"));
$("tabPlay").addEventListener("click", ()=>setHomeTab("play"));
$("tabTeach").addEventListener("click", ()=>setHomeTab("teach"));

/* PIN modal events */
$("btnPinSubmit").addEventListener("click", submitPin);
$("btnPinCancel").addEventListener("click", closePinModal);
$("btnPinClose").addEventListener("click", closePinModal);
$("pinInput").addEventListener("keydown", (e)=>{ if(e.key === "Enter") submitPin(); });

/* On load */
(function init(){
  // logos
  setLogo($("navLogo"));
  setLogo($("homeLogo"));
  setLogo($("splashLogo"));

  // splash once per session
  const splash = $("splash");
  const splashFill = $("splashFill");
  if(!sessionStorage.getItem("lc_splash_seen")){
    sessionStorage.setItem("lc_splash_seen", "1");
    splash.style.display = "grid";
    requestAnimationFrame(()=> splashFill.style.width = "100%");
    setTimeout(()=>{ splash.style.display = "none"; }, 1750);
  }

  const saved = loadState();
  if(saved) state = saved;

  // ensure defaults exist
  if(!state.teacherPin) state.teacherPin = "1111";
  if(state.reputation == null) state.reputation = 0.50;
  if(!state.costMode) state.costMode = "simple";

  if(!state.view) state.view = "start";

  setHomeTab("learn");
  render();
})();
</script>
</body>
</html>
