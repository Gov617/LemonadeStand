<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lemonade Class ‚Äî MVP</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a33; --text:#e9eefc; --muted:#a9b7e6;
      --line:rgba(255,255,255,.10); --good:#26d07c; --bad:#ff4d4d; --warn:#ffd166;
      --btn:#2b5cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #162552 0%, var(--bg) 55%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1020px; margin:0 auto; padding:24px}
    .top{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:38px;height:38px;border-radius:10px;
      background: linear-gradient(135deg, #ffdd57 0%, #ffd166 35%, #2b5cff 100%);
      box-shadow: 0 8px 22px rgba(43,92,255,.25);
    }
    h1{font-size:18px; margin:0}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.45fr .85fr; gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:800}
    label{display:block; font-size:13px; color:var(--muted); margin:12px 0 6px}
    input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color:var(--text);
      outline:none;
    }
    input[type="range"]{width:100%}
    .rangeRow{display:flex; gap:10px; align-items:center}
    .rangeVal{min-width:102px;text-align:right;color:var(--text);font-weight:900;}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:0; border-radius:12px; padding:12px 14px;
      background: rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      border:1px solid var(--line);
      transition: transform .05s ease;
    }
    button.primary{background: var(--btn); border-color: rgba(43,92,255,.6)}
    button.danger{background: rgba(255,77,77,.15); border-color: rgba(255,77,77,.45)}
    button.ok{background: rgba(38,208,124,.12); border-color: rgba(38,208,124,.45)}
    button:active{transform: scale(.98)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .muted{color:var(--muted); font-size:13px; line-height:1.4}
    .mini{font-size:12px;color:rgba(233,238,252,.70)}
    .big{font-size:34px; font-weight:950; letter-spacing:-.02em; margin:4px 0 6px;}
    .big.good{color:var(--good)}
    .big.bad{color:var(--bad)}
    .sep{height:1px;background:var(--line); margin:14px 0}
    .list{display:grid; gap:8px; margin-top:8px}
    .li{
      display:flex; justify-content:space-between; gap:10px;
      font-size:13px; color:var(--muted);
      padding:10px 10px;
      background: rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:12px;
    }
    .li b{color:var(--text)}
    .li .good{color:var(--good); font-weight:950}
    .li .bad{color:var(--bad); font-weight:950}

    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,209,102,.35);
      background: rgba(255,209,102,.10);
      color: #ffe7a7;
      font-size:13px;
      line-height:1.35;
    }
    .callout{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(43,92,255,.35);
      background: rgba(43,92,255,.10);
      color: rgba(233,238,252,.95);
      font-size:13px;
      line-height:1.35;
    }
    .selling{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:12px;
      background: rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      margin-top:10px;
    }
    .meter{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      padding:10px 12px; border-radius:14px;
      background: rgba(0,0,0,.15);
      border:1px solid var(--line);
      min-width:160px;
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:950;margin-top:2px}
    .hide{display:none !important}

    /* Reflection sheet */
    .sheet{
      margin-top:12px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
    }
    .sheet h3{margin:0 0 10px; font-size:15px}
    .q{
      display:grid; gap:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      margin-top:10px;
    }
    .q b{font-size:13px}
    .q textarea{
      width:100%;
      min-height:70px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px;
      outline:none;
      font-family: inherit;
      font-size:13px;
    }

    .defs{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.9);
      font-size:13px;
      line-height:1.35;
    }
    .defs summary{cursor:pointer; font-weight:900}
    .defs p{margin:8px 0 0; color: rgba(233,238,252,.82)}
    footer{margin-top:18px; color:rgba(233,238,252,.55); font-size:12px}

    /* Print styles */
    @media print{
      body{background:#fff; color:#000}
      .wrap{max-width:100%; padding:0}
      .top, #historyCard, #startView, #dayView { display:none !important; }
      #resultView{display:block !important}
      .card{box-shadow:none; border:1px solid #ddd; background:#fff}
      .pill{background:#f3f3f3; border-color:#ddd; color:#111}
      .muted{color:#222}
      .hint{color:#111; background:#fff6d6; border-color:#e7cf7a}
      .callout{color:#111; background:#eaf0ff; border-color:#b6c6ff}
      button{display:none !important}
      textarea{border:1px solid #bbb; background:#fff; color:#000}
      a{color:#000; text-decoration:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Lemonade Class <span class="sub">‚Äî Classroom MVP</span></h1>
          <div class="sub">A micro-business simulation (single-file, no login, no backend)</div>
        </div>
      </div>
      <div class="row">
        <div class="pill">üíµ Cash: <b id="cashPill">$0.00</b></div>
        <div class="pill">üìÖ Day: <b id="dayPill">‚Äî</b></div>
        <div class="pill">üéì Explain: <b id="explainPill">On</b></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <!-- START -->
        <div id="startView">
          <h2>Start</h2>
          <div class="muted">
            Run your stand for 5 or 7 days. Make decisions, watch sales happen, and learn what drives <b>profit</b>.
          </div>

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label>Student name</label>
              <input id="playerName" type="text" placeholder="e.g., Marcus" maxlength="24" />
            </div>
            <div style="flex:1">
              <label>Class code (optional)</label>
              <input id="classCode" type="text" placeholder="e.g., 6B-Period2" maxlength="24" />
              <div class="mini" style="margin-top:6px">This prints on the reflection sheet + saves into the CSV filename.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label>Teacher name (optional)</label>
              <input id="teacherName" type="text" placeholder="e.g., Ms. Rivera" maxlength="32" />
            </div>
            <div style="flex:1">
              <label>Game length</label>
              <select id="gameLen">
                <option value="5">5 days</option>
                <option value="7" selected>7 days</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label>Difficulty (teacher setting)</label>
              <select id="difficulty">
                <option value="guided">Guided (gentle)</option>
                <option value="standard" selected>Standard (recommended)</option>
                <option value="competitive">Competitive (no bailout)</option>
              </select>
              <div class="mini" style="margin-top:6px">Standard keeps students finishing the simulation.</div>
            </div>
            <div style="flex:1">
              <label>Explain Mode (teaching hints)</label>
              <select id="explainMode">
                <option value="on" selected>On</option>
                <option value="off">Off</option>
              </select>
              <div class="mini" style="margin-top:6px">On = definitions + tips show up during play.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div style="flex:1">
              <label>Starting cash (teacher setting)</label>
              <select id="startingCash">
                <option value="50">$50 (hard)</option>
                <option value="100" selected>$100 (normal)</option>
                <option value="150">$150 (easier)</option>
                <option value="200">$200 (very easy)</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Ingredient cost (COGS per cup)</label>
              <select id="cogsPerCup">
                <option value="0.35">$0.35 (low cost)</option>
                <option value="0.50" selected>$0.50 (default)</option>
                <option value="0.70">$0.70 (higher cost)</option>
                <option value="1.00">$1.00 (very high)</option>
              </select>
              <div class="mini" style="margin-top:6px">COGS = ‚ÄúCost of Goods Sold.‚Äù Bigger COGS makes margin tighter.</div>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnStart">Start Game</button>
            <button id="btnResume" class="hide">Resume Saved Game</button>
            <button class="danger hide" id="btnClear">Clear Save</button>
          </div>

          <div id="startTeaching" class="hint">
            <b>Teacher-ready:</b> students can export a CSV + print a reflection sheet at the end (or Save as PDF).
          </div>

          <div id="startDefs" class="defs">
            <details>
              <summary>Glossary (click)</summary>
              <p><b>Revenue</b> = money from sales (price √ó cups sold).<br/>
                 <b>COGS</b> = your ingredient cost to make the product.<br/>
                 <b>Profit</b> = revenue ‚àí (COGS + marketing).<br/>
                 <b>Margin</b> = profit √∑ revenue (how much you keep per dollar sold).</p>
            </details>
          </div>
        </div>

        <!-- DAY -->
        <div id="dayView" class="hide">
          <h2 id="dayTitle">Day</h2>

          <div class="row">
            <div class="pill">üå¶Ô∏è Forecast: <b id="wxPill">‚Äî</b></div>
            <div class="pill">üé™ City event: <b id="eventPill">‚Äî</b></div>
            <div class="pill">ü•§ Rival price: <b id="rivalPill">‚Äî</b></div>
          </div>

          <div class="sep"></div>

          <label>Cups to make</label>
          <div class="rangeRow">
            <input id="cups" type="range" min="0" max="200" value="80" />
            <div class="rangeVal" id="cupsVal">80</div>
          </div>

          <label>Price per cup</label>
          <div class="rangeRow">
            <input id="price" type="range" min="0.5" max="5" value="2.00" step="0.05" />
            <div class="rangeVal" id="priceVal">$2.00</div>
          </div>

          <label>Marketing spend</label>
          <div class="rangeRow">
            <input id="mkt" type="range" min="0" max="20" value="0" step="1" />
            <div class="rangeVal" id="mktVal">$0</div>
          </div>

          <!-- NEW: up-front cost preview -->
          <div class="callout" id="upfrontPreview">
            Up-front spend today: <b id="upfrontSpendVal">$0.00</b>
            <span class="mini"> (COGS <span id="cogsTag">$0.50</span> √ó cups + marketing)</span>
          </div>

          <div id="explainTips" class="hint hide"></div>

          <div class="btns">
            <button class="primary" id="btnSell">Start Selling</button>
            <button id="btnResetDay">Reset Inputs</button>
          </div>

          <div id="sellingBox" class="selling hide">
            <div style="min-width:260px">
              <b>Selling‚Ä¶</b> <span class="muted" id="sellingMsg">Customers are arriving.</span>
              <div class="mini">You already paid costs up-front. Now revenue comes in.</div>
            </div>
            <div class="meter">
              <div class="kpi"><div class="k">Customers</div><div class="v" id="kCustomers">0</div></div>
              <div class="kpi"><div class="k">Cups left</div><div class="v" id="kCupsLeft">‚Äî</div></div>
              <div class="kpi"><div class="k">Revenue</div><div class="v" id="kRevenue">$0</div></div>
            </div>
          </div>

          <div id="dayHint" class="hint hide"></div>
        </div>

        <!-- RESULTS -->
        <div id="resultView" class="hide">
          <h2 id="resultTitle">Results</h2>
          <div id="profitBig" class="big">$0.00</div>
          <div class="muted" id="resultNarrative">‚Äî</div>

          <div class="sep"></div>
          <div class="list" id="resultList"></div>

          <div id="lessonBox" class="hint"></div>

          <div class="btns">
            <button class="primary" id="btnNext">Next Day</button>
            <button id="btnPlayAgain" class="hide">Play Again</button>
            <button class="ok" id="btnCSV" title="Download a CSV of your run">Download CSV</button>
            <button id="btnPrint" title="Print / Save as PDF reflection sheet">Print Reflection</button>
          </div>

          <!-- End-of-run summary -->
          <div id="summaryBox" class="sheet hide">
            <h3>End-of-Run Summary</h3>
            <div class="list" id="summaryList"></div>
          </div>

          <!-- Reflection Sheet -->
          <div id="reflectionSheet" class="sheet hide">
            <h3>Reflection Sheet (Lemonade Class)</h3>
            <div class="row" style="margin-top:6px">
              <div class="pill">üë§ Student: <b id="refName">‚Äî</b></div>
              <div class="pill">üè´ Class: <b id="refClass">‚Äî</b></div>
              <div class="pill">üë©üèΩ‚Äçüè´ Teacher: <b id="refTeacher">‚Äî</b></div>
              <div class="pill">üìÖ Days: <b id="refDays">‚Äî</b></div>
              <div class="pill">üíµ Final cash: <b id="refFinalCash">‚Äî</b></div>
              <div class="pill">üìà Total profit: <b id="refTotalProfit">‚Äî</b></div>
            </div>

            <div class="q">
              <b>1) What was your most profitable day, and why do you think it worked?</b>
              <textarea id="q1" placeholder="Write 2‚Äì4 sentences..."></textarea>
            </div>

            <div class="q">
              <b>2) Describe one mistake you made (price, production, marketing) and what you learned from it.</b>
              <textarea id="q2" placeholder="Write 2‚Äì4 sentences..."></textarea>
            </div>

            <div class="q">
              <b>3) If you played again, what strategy would you try?</b>
              <textarea id="q3" placeholder="Write 2‚Äì4 sentences..."></textarea>
            </div>

            <div class="q">
              <b>4) Revenue vs Profit: In your own words, what‚Äôs the difference?</b>
              <textarea id="q4" placeholder="Write 1‚Äì3 sentences..."></textarea>
            </div>

            <div class="defs">
              <details open>
                <summary>Quick Definitions</summary>
                <p><b>Revenue</b> = price √ó cups sold<br/>
                   <b>COGS</b> = ingredient cost to make the cups you prepared<br/>
                   <b>Gross Margin</b> = (Revenue ‚àí COGS) √∑ Revenue<br/>
                   <b>Profit Margin</b> = Profit √∑ Revenue</p>
              </details>
            </div>

            <div class="mini" style="margin-top:10px">
              This reflection can be printed (or saved as PDF). In the MVP, answers are not sent anywhere.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="historyCard">
        <h2>Scoreboard</h2>
        <div class="muted">This run is saved locally on this device. (Future: teacher codes + class leaderboard)</div>
        <div class="sep"></div>
        <div class="list" id="history"></div>
        <div class="sep"></div>
        <div class="muted">
          <b>What this teaches:</b> revenue vs profit, cost & margin, inventory waste, price sensitivity, demand shifts (weather/events), and strategic adjustment.
        </div>
        <footer>¬© Lemonade Class ‚Äî single-file classroom prototype.</footer>
      </div>
    </div>
  </div>

<script>
/** Lemonade Class ‚Äî Ultimate Classroom MVP (single-file)
 *  - Costs paid up-front
 *  - Up-front spend preview
 *  - Teacher settings: class code, teacher name, starting cash, COGS per cup, explain mode
 *  - CSV export + printable reflection sheet
 */

const $ = (id) => document.getElementById(id);
const money = (n) => (n < 0 ? `-$${Math.abs(n).toFixed(2)}` : `$${n.toFixed(2)}`);
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

const STORE_KEY = "lemonade_class_ultimate_v1";

const WEATHER = [
  { key:"Hot",   icon:"‚òÄÔ∏è", mult:1.35 },
  { key:"Mild",  icon:"üå§Ô∏è", mult:1.00 },
  { key:"Rainy", icon:"üåßÔ∏è", mult:0.60 },
];

const EVENTS = [
  { key:"None", icon:"‚Äî", mult:1.00, chance:0.50 },
  { key:"Street Fair", icon:"üé™", mult:1.40, chance:0.18 },
  { key:"Construction", icon:"üöß", mult:0.75, chance:0.16 },
  { key:"Sports Game Nearby", icon:"üèÄ", mult:1.20, chance:0.16 },
];

function pickWeighted(items){
  const r = Math.random();
  let s = 0;
  for(const it of items){
    s += it.chance;
    if(r <= s) return it;
  }
  return items[items.length-1];
}
function randBetween(a,b){ return a + Math.random()*(b-a); }

function priceFactor(price, difficulty){
  const sweet = 2.00;
  const delta = price - sweet;
  const harsh = (difficulty === "competitive") ? 1.15 : (difficulty === "guided" ? 0.85 : 1.0);
  if(delta > 0){
    const f = 1 - (0.18 * harsh) * delta;
    return clamp(f, 0.20, 1.00);
  } else {
    const f = 1 + (0.10 * (1/harsh)) * Math.abs(delta);
    return clamp(f, 0.60, 1.40);
  }
}
function marketingFactor(mkt){
  return 1 + 0.015 * clamp(mkt, 0, 20);
}
function competitorFactor(price, rivalPrice, difficulty){
  const d = price - rivalPrice;
  const harsh = (difficulty === "competitive") ? 1.1 : (difficulty === "guided" ? 0.9 : 1.0);
  if(d > 0){
    const f = 1 - (0.22 * harsh) * d;
    return clamp(f, 0.35, 1.00);
  } else {
    const f = 1 + 0.10 * Math.abs(d);
    return clamp(f, 0.70, 1.25);
  }
}
function dailyDemand({weatherMult, eventMult, price, mkt, rivalPrice, difficulty}){
  const base = 60;
  const pf = priceFactor(price, difficulty);
  const mf = marketingFactor(mkt);
  const cf = competitorFactor(price, rivalPrice, difficulty);
  const noise = randBetween(0.85, 1.15);
  return Math.max(0, Math.round(base * weatherMult * eventMult * pf * mf * cf * noise));
}

function lessonFor({cupsMade, cupsSold, price, profit, demand, missedSales, wasteCost}){
  const waste = cupsMade - cupsSold;
  if(cupsSold === 0 && cupsMade > 0) return "Demand collapsed. Either price was too high, or conditions were bad. Markets can say ‚Äúno.‚Äù";
  if(waste >= Math.max(10, Math.round(cupsMade*0.25))) return `You over-produced. Waste cost you ${money(wasteCost)}. Inventory decisions matter.`;
  if(cupsSold === cupsMade && demand > cupsMade) return `You sold out and missed ~${missedSales} sales. Next time produce more or raise price.`;
  if(profit < 0) return "You lost money today. That‚Äôs not failure ‚Äî it‚Äôs feedback. Adjust and recover.";
  if(price > 2.75) return "Higher prices increase margin, but demand can fall fast. Balance volume vs margin.";
  if(price < 1.25) return "Low prices can boost demand, but profit per cup might be too low. Margin matters.";
  return "Nice balance. The best strategy matches price + inventory to real demand.";
}

function narrativeFor({weatherKey, eventKey, rivalPrice, price, cupsSold, cupsMade}){
  const waste = cupsMade - cupsSold;
  if(cupsSold === cupsMade && cupsMade > 0) return `You sold out on a ${weatherKey} day. Rival was at ${money(rivalPrice)} ‚Äî your pricing kept demand strong.`;
  if(waste > 0) return `Demand was softer than expected (${weatherKey}${eventKey!=="None" ? " + "+eventKey : ""}). Leftovers became waste.`;
  return `A steady day (${weatherKey}${eventKey!=="None" ? " + "+eventKey : ""}). Pricing at ${money(price)} kept sales moving.`;
}

function pct(n){ return `${(n*100).toFixed(0)}%`; }
function safeDiv(a,b){ return b === 0 ? 0 : a/b; }

// ----------- State -----------
function freshState(){
  return {
    playerName: "",
    classCode: "",
    teacherName: "",
    daysTotal: 7,
    difficulty: "standard",
    explainMode: "on",
    startingCash: 100,
    cogsPerCup: 0.50,

    day: 1,
    cash: 100,
    history: [],
    todays: null,
    view: "start"
  };
}

let state = loadState() ?? freshState();

function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function clearState(){
  localStorage.removeItem(STORE_KEY);
  state = freshState();
  render();
}

// ----------- UI wiring -----------
function show(view){
  $("startView").classList.toggle("hide", view !== "start");
  $("dayView").classList.toggle("hide", view !== "day");
  $("resultView").classList.toggle("hide", view !== "result");
  state.view = view;
  saveState();
}

function setHeader(){
  $("cashPill").textContent = money(state.cash);
  $("dayPill").textContent = state.view === "start" ? "‚Äî" : `${Math.min(state.day, state.daysTotal)} / ${state.daysTotal}`;
  $("explainPill").textContent = (state.explainMode === "on") ? "On" : "Off";
}

function renderHistory(){
  const box = $("history");
  box.innerHTML = "";
  if(state.history.length === 0){
    box.innerHTML = `<div class="li"><span>No days yet</span><b>‚Äî</b></div>`;
    return;
  }
  state.history.slice().reverse().forEach((h) => {
    const label = `Day ${h.day} ‚Ä¢ ${h.weather.icon} ${h.weather.key}`;
    const value = `<span class="${h.netProfit>=0?'good':'bad'}">${money(h.netProfit)}</span>`;
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${label}</span><b>${value}</b>`;
    box.appendChild(div);
  });
}

function maybeShowResume(){
  const saved = loadState();
  const showBtns = !!saved && state.view === "start" && (saved.history?.length ?? 0) > 0;
  $("btnResume").classList.toggle("hide", !showBtns);
  $("btnClear").classList.toggle("hide", !showBtns);
}

function renderStart(){
  $("playerName").value = state.playerName || "";
  $("classCode").value = state.classCode || "";
  $("teacherName").value = state.teacherName || "";
  $("gameLen").value = String(state.daysTotal || 7);
  $("difficulty").value = state.difficulty || "standard";
  $("explainMode").value = state.explainMode || "on";
  $("startingCash").value = String(state.startingCash || 100);
  $("cogsPerCup").value = String(state.cogsPerCup ?? 0.5);

  // hide glossary if explain off
  $("startDefs").classList.toggle("hide", (state.explainMode !== "on"));
  maybeShowResume();
}

function newDayContext(){
  const weather = WEATHER[Math.floor(Math.random()*WEATHER.length)];
  const event = pickWeighted(EVENTS);
  const rivalPrice = clamp(randBetween(1.10, 2.90), 0.75, 3.25);
  state.todays = { weather, event, rivalPrice };
  saveState();
}

function syncInputs(){
  $("cupsVal").textContent = `${$("cups").value}`;
  $("priceVal").textContent = money(parseFloat($("price").value));
  $("mktVal").textContent = `$${parseInt($("mkt").value,10)}`;

  // Up-front preview
  const cups = parseInt($("cups").value,10);
  const mkt = parseInt($("mkt").value,10);
  const cogs = Number(state.cogsPerCup ?? 0.50);
  const cost = cups * cogs;
  const upfront = cost + mkt;

  $("cogsTag").textContent = money(cogs);
  $("upfrontSpendVal").textContent = money(upfront);

  if(state.explainMode === "on"){
    const tip =
      `Tip: Your up-front spend is what you pay before selling. If you spend too much and demand is low, you can lose money.`;
    $("explainTips").classList.remove("hide");
    $("explainTips").textContent = tip;
  } else {
    $("explainTips").classList.add("hide");
  }
}

function renderDay(){
  if(!state.todays) newDayContext();
  const { weather, event, rivalPrice } = state.todays;

  $("dayTitle").textContent = `Day ${state.day} ‚Äî Make your decisions`;
  $("wxPill").textContent = `${weather.icon} ${weather.key}`;
  $("eventPill").textContent = `${event.icon} ${event.key}`;
  $("rivalPill").textContent = money(rivalPrice);

  $("cups").value = 80;
  $("price").value = 2.00;
  $("mkt").value = 0;

  $("sellingBox").classList.add("hide");
  $("dayHint").classList.add("hide");
  $("dayHint").textContent = "";
  $("sellingMsg").textContent = "Customers are arriving.";

  syncInputs();
}

function computeTotals(){
  const totalRevenue = state.history.reduce((s,h)=>s+h.revenue,0);
  const totalCOGS = state.history.reduce((s,h)=>s+h.cost,0);
  const totalMkt = state.history.reduce((s,h)=>s+h.marketing,0);
  const totalProfit = state.history.reduce((s,h)=>s+h.netProfit,0);
  const totalSold = state.history.reduce((s,h)=>s+h.cupsSold,0);
  const totalMade = state.history.reduce((s,h)=>s+h.cupsMade,0);
  const totalWaste = state.history.reduce((s,h)=>s+h.waste,0);
  const missedSales = state.history.reduce((s,h)=>s+h.missedSales,0);

  const grossMargin = safeDiv((totalRevenue - totalCOGS), totalRevenue);
  const profitMargin = safeDiv(totalProfit, totalRevenue);

  const best = state.history.reduce((a,b)=> (b.netProfit>a.netProfit?b:a), state.history[0] || null);
  const worst = state.history.reduce((a,b)=> (b.netProfit<a.netProfit?b:a), state.history[0] || null);

  return {
    totalRevenue, totalCOGS, totalMkt, totalProfit,
    totalSold, totalMade, totalWaste, missedSales,
    grossMargin, profitMargin,
    best, worst
  };
}

function fillSummary(){
  const s = $("summaryList");
  s.innerHTML = "";
  if(state.history.length === 0) return;

  const t = computeTotals();
  const avgProfit = t.totalProfit / state.history.length;

  const rows = [
    ["Total Revenue", money(t.totalRevenue)],
    ["Total COGS", money(t.totalCOGS)],
    ["Total Marketing", money(t.totalMkt)],
    ["Total Profit", `<span class="${t.totalProfit>=0?'good':'bad'}">${money(t.totalProfit)}</span>`],
    ["Gross Margin", pct(t.grossMargin)],
    ["Profit Margin", pct(t.profitMargin)],
    ["Cups Made", String(t.totalMade)],
    ["Cups Sold", String(t.totalSold)],
    ["Cups Wasted", String(t.totalWaste)],
    ["Missed Sales (sold out)", String(t.missedSales)],
    ["Avg Profit / Day", `<span class="${avgProfit>=0?'good':'bad'}">${money(avgProfit)}</span>`],
    ["Best Day", t.best ? `Day ${t.best.day} (${money(t.best.netProfit)})` : "‚Äî"],
    ["Worst Day", t.worst ? `Day ${t.worst.day} (${money(t.worst.netProfit)})` : "‚Äî"],
  ];

  for(const [k,v] of rows){
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${k}</span><b>${v}</b>`;
    s.appendChild(div);
  }
}

function fillReflectionSheet(){
  const finalCash = state.cash;
  const totalProfit = finalCash - state.startingCash;

  $("refName").textContent = state.playerName || "Student";
  $("refClass").textContent = state.classCode || "‚Äî";
  $("refTeacher").textContent = state.teacherName || "‚Äî";
  $("refDays").textContent = `${state.daysTotal}`;
  $("refFinalCash").textContent = money(finalCash);
  $("refTotalProfit").textContent = money(totalProfit);

  if(state.history.length > 0){
    const best = state.history.reduce((a,b)=> (b.netProfit>a.netProfit?b:a), state.history[0]);
    const worst = state.history.reduce((a,b)=> (b.netProfit<a.netProfit?b:a), state.history[0]);
    const q1Default = `My most profitable day was Day ${best.day} (${best.weather.key}). I think it worked because my price was ${money(best.price)} and I made ${best.cupsMade} cups.`;
    const q2Default = `One mistake I made was on Day ${worst.day}. I ${worst.waste>0 ? "made too many cups and wasted inventory" : "didn't capture enough demand or priced wrong"}. Next time I would adjust price/production.`;
    if(!$("q1").value) $("q1").value = q1Default;
    if(!$("q2").value) $("q2").value = q2Default;
  }
}

function renderResult(last){
  $("resultTitle").textContent = (state.day > state.daysTotal) ? "Final Results" : `Day ${last.day} Results`;

  const big = $("profitBig");
  big.textContent = money(last.netProfit);
  big.className = "big " + (last.netProfit >= 0 ? "good" : "bad");

  $("resultNarrative").textContent = last.narrative;

  const list = $("resultList");
  list.innerHTML = "";

  const grossMargin = safeDiv((last.revenue - last.cost), last.revenue);
  const profitMargin = safeDiv(last.netProfit, last.revenue);

  const rows = [
    ["Customers (demand)", String(last.demand)],
    ["Cups made", String(last.cupsMade)],
    ["Cups sold", String(last.cupsSold)],
    ["Missed sales (sold out)", String(last.missedSales)],
    ["Cups wasted", String(last.waste)],
    ["Waste cost", money(last.wasteCost)],
    ["Revenue", money(last.revenue)],
    ["COGS (ingredients)", money(last.cost)],
    ["Marketing", money(last.marketing)],
    ["Net profit", `<span class="${last.netProfit>=0?'good':'bad'}">${money(last.netProfit)}</span>`],
    ["Gross margin", pct(grossMargin)],
    ["Profit margin", pct(profitMargin)],
    ["Cash balance", money(last.cashAfter)],
  ];

  rows.forEach(([k,v]) => {
    const div = document.createElement("div");
    div.className = "li";
    div.innerHTML = `<span>${k}</span><b>${v}</b>`;
    list.appendChild(div);
  });

  $("lessonBox").textContent = "üìå " + last.lesson;

  const finished = state.day > state.daysTotal;
  $("btnNext").classList.toggle("hide", finished);
  $("btnPlayAgain").classList.toggle("hide", !finished);

  $("reflectionSheet").classList.toggle("hide", !finished);
  $("summaryBox").classList.toggle("hide", !finished);

  if(finished){
    fillSummary();
    fillReflectionSheet();
  }

  $("btnCSV").disabled = (state.history.length === 0);
  $("btnPrint").disabled = !finished;
}

function bailoutIfNeeded(){
  if(state.cash >= 0) return;
  if(state.difficulty === "competitive") return;

  const loan = Math.abs(state.cash) + 25;
  state.cash += loan;
  state._bailoutNote =
    `Emergency bailout: you received ${money(loan)} so you can finish. In real life this could be savings or a small loan.`;
}

function render(){
  setHeader();
  renderHistory();
  if(state.view === "start"){ show("start"); renderStart(); }
  else if(state.view === "day"){ show("day"); renderDay(); }
  else if(state.view === "result"){ show("result"); }
  setHeader();
  renderHistory();
}

// ----------- CSV export -----------
function toCSV(){
  const headers = [
    "studentName","classCode","teacherName",
    "daysTotal","difficulty","explainMode",
    "startingCash","cogsPerCup",
    "day","weather","event","rivalPrice",
    "cupsMade","price","marketing",
    "demand","cupsSold","missedSales","waste","wasteCost",
    "revenue","cogsCost","netProfit","cashAfter"
  ];

  const esc = (v) => {
    const s = String(v ?? "");
    if(s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
    return s;
  };

  const lines = [];
  lines.push(headers.join(","));

  for(const h of state.history){
    const row = [
      state.playerName,
      state.classCode,
      state.teacherName,
      state.daysTotal,
      state.difficulty,
      state.explainMode,
      state.startingCash,
      state.cogsPerCup,
      h.day,
      h.weather.key,
      h.event.key,
      h.rivalPrice.toFixed(2),
      h.cupsMade,
      h.price.toFixed(2),
      h.marketing,
      h.demand,
      h.cupsSold,
      h.missedSales,
      h.waste,
      h.wasteCost.toFixed(2),
      h.revenue.toFixed(2),
      h.cost.toFixed(2),
      h.netProfit.toFixed(2),
      h.cashAfter.toFixed(2),
    ].map(esc);
    lines.push(row.join(","));
  }

  const totalProfit = state.cash - state.startingCash;
  lines.push("");
  lines.push(`Final Cash,${state.cash.toFixed(2)}`);
  lines.push(`Total Profit,${totalProfit.toFixed(2)}`);

  return lines.join("\n");
}

function downloadCSV(){
  const csv = toCSV();
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeName = (state.playerName || "student").replace(/[^a-z0-9_-]/gi,"_");
  const safeClass = (state.classCode || "class").replace(/[^a-z0-9_-]/gi,"_");
  a.href = url;
  a.download = `lemonade_class_${safeClass}_${safeName}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function printReflection(){
  $("reflectionSheet").classList.remove("hide");
  $("summaryBox").classList.remove("hide");
  window.print();
}

// ----------- Game actions -----------
async function startGame(){
  const name = $("playerName").value.trim() || "Student";
  state = freshState();

  state.playerName = name;
  state.classCode = ($("classCode").value || "").trim();
  state.teacherName = ($("teacherName").value || "").trim();

  state.daysTotal = parseInt($("gameLen").value, 10);
  state.difficulty = $("difficulty").value;
  state.explainMode = $("explainMode").value;
  state.startingCash = parseFloat($("startingCash").value);
  state.cogsPerCup = parseFloat($("cogsPerCup").value);

  state.day = 1;
  state.cash = state.startingCash;
  state.history = [];
  state.todays = null;
  state.view = "day";

  saveState();
  render();
}

function resumeGame(){
  const loaded = loadState();
  if(loaded){ state = loaded; render(); }
}
function resetDayInputs(){
  $("cups").value = 80;
  $("price").value = 2.00;
  $("mkt").value = 0;
  syncInputs();
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function sellDay(){
  const cupsMade = parseInt($("cups").value, 10);
  const price = parseFloat($("price").value);
  const marketing = parseInt($("mkt").value, 10);
  const cogsPerCup = Number(state.cogsPerCup ?? 0.50);

  const { weather, event, rivalPrice } = state.todays;

  const demand = dailyDemand({
    weatherMult: weather.mult,
    eventMult: event.mult,
    price,
    mkt: marketing,
    rivalPrice,
    difficulty: state.difficulty
  });

  const cupsSold = Math.min(cupsMade, demand);
  const missedSales = Math.max(0, demand - cupsSold);
  const waste = Math.max(0, cupsMade - cupsSold);

  const revenue = cupsSold * price;
  const cost = cupsMade * cogsPerCup;
  const wasteCost = waste * cogsPerCup;
  const upfrontSpend = cost + marketing;

  // Need cash up-front
  if(upfrontSpend > state.cash){
    $("dayHint").classList.remove("hide");
    $("dayHint").textContent =
      `You need ${money(upfrontSpend)} to make ${cupsMade} cups + marketing, but you only have ${money(state.cash)}. Lower cups or marketing.`;
    return;
  }

  // Pay up-front
  state.cash = parseFloat((state.cash - upfrontSpend).toFixed(2));
  saveState();
  setHeader();

  // Selling phase UI
  $("sellingBox").classList.remove("hide");
  $("btnSell").disabled = true;
  $("sellingMsg").textContent = `Paid ${money(upfrontSpend)} up-front. Selling now...`;

  $("kCustomers").textContent = "0";
  $("kCupsLeft").textContent = String(cupsMade);
  $("kRevenue").textContent = "$0";

  const durationMs = 9000;
  const steps = 30;
  const stepMs = Math.round(durationMs/steps);

  for(let i=1;i<=steps;i++){
    const t = i/steps;
    const shownCustomers = Math.round(demand * t);
    const shownSold = Math.min(cupsMade, Math.round(cupsSold * t));
    const shownLeft = Math.max(0, cupsMade - shownSold);
    const shownRevenue = shownSold * price;

    $("kCustomers").textContent = String(shownCustomers);
    $("kCupsLeft").textContent = String(shownLeft);
    $("kRevenue").textContent = money(shownRevenue);

    if(shownLeft === 0 && cupsMade > 0){
      $("sellingMsg").textContent = "Sold out! Missed customers you could have served.";
      await sleep(700);
      break;
    }
    await sleep(stepMs);
  }

  $("btnSell").disabled = false;
  $("sellingBox").classList.add("hide");

  // Add revenue after selling
  state.cash = parseFloat((state.cash + revenue).toFixed(2));

  const netProfit = revenue - upfrontSpend;

  bailoutIfNeeded();

  const narrative = narrativeFor({weatherKey: weather.key, eventKey: event.key, rivalPrice, price, cupsSold, cupsMade});
  const lesson = lessonFor({cupsMade, cupsSold, price, profit: netProfit, demand, missedSales, wasteCost});

  const record = {
    day: state.day,
    weather, event, rivalPrice,
    cupsMade, price, marketing,
    demand, cupsSold, missedSales,
    waste, wasteCost,
    revenue: parseFloat(revenue.toFixed(2)),
    cost: parseFloat(cost.toFixed(2)),
    netProfit: parseFloat(netProfit.toFixed(2)),
    cashAfter: state.cash,
    narrative,
    lesson
  };

  state.history.push(record);

  state.day += 1;
  state.todays = null;

  state.view = "result";
  saveState();
  show("result");
  setHeader();
  renderHistory();
  renderResult(record);

  if(state._bailoutNote){
    $("lessonBox").textContent = "üìå " + record.lesson + " ‚Äî " + state._bailoutNote;
    delete state._bailoutNote;
    saveState();
  }

  if(state.day > state.daysTotal){
    const totalProfit = state.cash - state.startingCash;
    const finalNote = totalProfit >= 0
      ? `Finish strong. You grew ${money(state.startingCash)} into ${money(state.cash)}. What would you reinvest in next?`
      : `You finished at ${money(state.cash)}. What one change would you make to become profitable?`;
    $("resultNarrative").textContent = finalNote;
  }
}

function nextDay(){
  if(state.day > state.daysTotal) return;
  state.view = "day";
  saveState();
  show("day");
  renderDay();
  setHeader();
}

function playAgain(){
  clearState();
}

// ----------- Event listeners -----------
$("cups").addEventListener("input", syncInputs);
$("price").addEventListener("input", syncInputs);
$("mkt").addEventListener("input", syncInputs);

$("btnStart").addEventListener("click", startGame);
$("btnResume").addEventListener("click", resumeGame);
$("btnClear").addEventListener("click", clearState);
$("btnSell").addEventListener("click", sellDay);
$("btnResetDay").addEventListener("click", resetDayInputs);
$("btnNext").addEventListener("click", nextDay);
$("btnPlayAgain").addEventListener("click", playAgain);

$("btnCSV").addEventListener("click", downloadCSV);
$("btnPrint").addEventListener("click", printReflection);

// On load
(function init(){
  const saved = loadState();
  if(saved) state = saved;
  if(!state.view) state.view = "start";

  // sync header explain pill
  setHeader();
  renderHistory();

  if(state.view === "result" && state.history.length > 0){
    show("result");
    setHeader();
    renderHistory();
    renderResult(state.history[state.history.length - 1]);
  } else if(state.view === "day"){
    show("day");
    renderDay();
  } else {
    show("start");
    renderStart();
  }

  setHeader();
  maybeShowResume();
})();
</script>
</body>
</html>
